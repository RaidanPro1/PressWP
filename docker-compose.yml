version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.email=${CF_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    environment:
      - CLOUDFLARE_EMAIL=${CF_EMAIL}
      - CLOUDFLARE_DNS_API_TOKEN=${CF_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/traefik/letsencrypt:/letsencrypt
    networks:
      - yemenjpt-net

  frontend:
    image: node:18-alpine
    container_name: yemenjpt-frontend
    restart: unless-stopped
    working_dir: /app
    volumes:
      - .:/app
    command: >
      sh -c "npm install -g http-server && http-server -p 8080 --proxy http://localhost:8080?"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=cloudflare"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
    networks:
      - yemenjpt-net

  bot-server:
    build: ./bot-server
    container_name: yemenjpt-bot-server
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bot-server.rule=Host(`${DOMAIN}`) && PathPrefix(`/bot-api`)"
      - "traefik.http.routers.bot-server.entrypoints=websecure"
      - "traefik.http.routers.bot-server.tls.certresolver=cloudflare"
      - "traefik.http.services.bot-server.loadbalancer.server.port=3000"
    networks:
      - yemenjpt-net

  postgres:
    image: postgres:15-alpine
    container_name: yemenjpt-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=yemenjpt
      - POSTGRES_PASSWORD=${UNIFIED_PASS}
      - POSTGRES_DB=yemenjpt_db
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - yemenjpt-net

  portainer:
    image: portainer/portainer-ce:latest
    container_name: yemenjpt-portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/portainer:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`sys.${DOMAIN}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=cloudflare"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
    networks:
      - yemenjpt-net
      
  dashy:
    image: lissy93/dashy:latest
    container_name: yemenjpt-dashy
    restart: unless-stopped
    volumes:
      - ./dashy.conf.yml:/app/public/conf.yml
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashy.rule=Host(`portal.${DOMAIN}`)"
      - "traefik.http.routers.dashy.entrypoints=websecure"
      - "traefik.http.routers.dashy.tls.certresolver=cloudflare"
      - "traefik.http.services.dashy.loadbalancer.server.port=80"
    networks:
      - yemenjpt-net

  glances:
    image: nicolargo/glances:latest-full
    container_name: yemenjpt-glances
    restart: unless-stopped
    pid: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glances.rule=Host(`glances.${DOMAIN}`)"
      - "traefik.http.routers.glances.entrypoints=websecure"
      - "traefik.http.routers.glances.tls.certresolver=cloudflare"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
    networks:
      - yemenjpt-net
      
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: yemenjpt-uptime-kuma
    restart: unless-stopped
    volumes:
      - ./data/uptime-kuma:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime-kuma.rule=Host(`status.${DOMAIN}`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls.certresolver=cloudflare"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"
    networks:
      - yemenjpt-net

  gitea:
    image: gitea/gitea:1.21
    container_name: yemenjpt-gitea
    restart: unless-stopped
    volumes:
      - ./data/gitea:/data
    environment:
      - USER_UID=1000
      - USER_GID=1000
    depends_on:
      - postgres
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.rule=Host(`git.${DOMAIN}`)"
      - "traefik.http.routers.gitea.entrypoints=websecure"
      - "traefik.http.routers.gitea.tls.certresolver=cloudflare"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
    networks:
      - yemenjpt-net

  n8n:
    image: n8nio/n8n:latest
    container_name: yemenjpt-n8n
    restart: unless-stopped
    volumes:
      - ./data/n8n:/home/node/.n8n
    environment:
      - N8N_HOST=${DOMAIN}
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${DOMAIN}/
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`auto.${DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=cloudflare"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    networks:
      - yemenjpt-net

  ollama:
    image: ollama/ollama:latest
    container_name: yemenjpt-ollama
    restart: unless-stopped
    volumes:
      - ./data/ollama:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - yemenjpt-net

networks:
  yemenjpt-net:
    driver: bridge
